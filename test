import tkinter as tk
from tkinter import messagebox
import random

class AdvancedMemoryGame:
    def __init__(self, root):
        self.root = root
        self.root.title("è¨˜æ†¶ç¿»ç‰Œï¼šç”Ÿå­˜æŒ‘æˆ°ç‰ˆ")
        
        # --- éŠæˆ²åƒæ•¸è¨­å®š ---
        self.total_time = 60    # åˆå§‹æ™‚é–“ 60 ç§’
        self.peek_uses = 1      # é€è¦–çœ¼å¯ç”¨æ¬¡æ•¸
        self.game_running = False
        
        # --- éŠæˆ²è®Šæ•¸ ---
        self.buttons = []
        self.cards = []
        self.first_selection = None
        self.second_selection = None
        self.matches_found = 0
        self.is_checking = False # é–å®šç‹€æ…‹
        self.symbols = ['ğŸ', 'ğŸŒ', 'ğŸ‡', 'ğŸ‰', 'ğŸ¶', 'ğŸ±', 'ğŸš—', 'ğŸš€']

        # --- å»ºç«‹ä»‹é¢ ---
        self.create_ui()
        self.setup_board()
        
        # --- å•Ÿå‹•è¨ˆæ™‚å™¨ ---
        self.start_timer()

    def create_ui(self):
        # 1. é ‚éƒ¨è³‡è¨Šå€ (é¡¯ç¤ºæ™‚é–“èˆ‡ç‹€æ…‹)
        info_frame = tk.Frame(self.root)
        info_frame.pack(pady=10)

        self.time_label = tk.Label(info_frame, text=f"â³ æ™‚é–“: {self.total_time}", font=("Arial", 16, "bold"), fg="blue")
        self.time_label.pack(side=tk.LEFT, padx=20)

        # 2. éŠæˆ²å€åŸŸ (ç¶²æ ¼)
        self.game_frame = tk.Frame(self.root)
        self.game_frame.pack()

        # 3. åº•éƒ¨åŠŸèƒ½å€ (é€è¦–çœ¼èˆ‡é‡ç½®)
        control_frame = tk.Frame(self.root)
        control_frame.pack(pady=10)

        self.peek_btn = tk.Button(control_frame, text=f"ğŸ‘ï¸ é€è¦–çœ¼ ({self.peek_uses})", 
                                  command=self.use_peek, bg="gold", font=("Arial", 12))
        self.peek_btn.pack(side=tk.LEFT, padx=10)

        restart_btn = tk.Button(control_frame, text="ğŸ”„ é‡æ–°é–‹å§‹", 
                                command=self.reset_game, bg="lightblue", font=("Arial", 12))
        restart_btn.pack(side=tk.LEFT, padx=10)

    def setup_board(self):
        # æ¸…ç©ºèˆŠæŒ‰éˆ• (å¦‚æœæ˜¯é‡ç½®æ™‚)
        for widget in self.game_frame.winfo_children():
            widget.destroy()
        
        self.buttons = []
        self.cards = self.symbols * 2
        random.shuffle(self.cards)
        
        for i in range(16):
            btn = tk.Button(self.game_frame, text=" ", font=("Arial", 24), 
                            width=4, height=2,
                            command=lambda index=i: self.on_card_click(index))
            btn.grid(row=i//4, column=i%4, padx=5, pady=5)
            self.buttons.append(btn)
        
        self.game_running = True

    def start_timer(self):
        if self.game_running and self.total_time > 0:
            self.total_time -= 1
            self.update_time_label()
            # æ¯ 1000 æ¯«ç§’ (1ç§’) å‘¼å«è‡ªå·±ä¸€æ¬¡
            self.root.after(1000, self.start_timer)
        elif self.total_time <= 0 and self.game_running:
            self.game_over(win=False)

    def update_time_label(self):
        self.time_label.config(text=f"â³ æ™‚é–“: {self.total_time}")
        # æ™‚é–“å°‘æ–¼ 10 ç§’è®Šç´…è‰²è­¦å‘Š
        if self.total_time < 10:
            self.time_label.config(fg="red")
        else:
            self.time_label.config(fg="blue")

    def use_peek(self):
        # ç‰¹æ®Šç©æ³•ï¼šé€è¦–çœ¼
        if self.peek_uses > 0 and not self.is_checking and self.game_running:
            self.peek_uses -= 1
            self.peek_btn.config(text=f"ğŸ‘ï¸ é€è¦–çœ¼ ({self.peek_uses})", state="disabled")
            
            self.is_checking = True # é–å®šä¸è®“ç©å®¶é»æ“Š
            
            # æš«æ™‚é¡¯ç¤ºæ‰€æœ‰æœªé…å°çš„ç‰Œ
            for i, btn in enumerate(self.buttons):
                if btn['state'] != 'disabled': # åªé¡¯ç¤ºé‚„æ²’é…å°æˆåŠŸçš„
                    btn.config(text=self.cards[i], bg="lightyellow")
            
            # 1.5 ç§’å¾Œè“‹å›å»
            self.root.after(1500, self.hide_all_cards)

    def hide_all_cards(self):
        for i, btn in enumerate(self.buttons):
            if btn['state'] != 'disabled':
                btn.config(text=" ", bg="SystemButtonFace")
        self.is_checking = False # è§£é–

    def on_card_click(self, index):
        if self.is_checking or not self.game_running or self.buttons[index]['text'] != " ":
            return

        self.buttons[index].config(text=self.cards[index], bg="white")

        if self.first_selection is None:
            self.first_selection = index
        else:
            self.second_selection = index
            self.is_checking = True
            self.check_match()

    def check_match(self):
        idx1, idx2 = self.first_selection, self.second_selection
        
        if self.cards[idx1] == self.cards[idx2]:
            # é…å°æˆåŠŸ
            self.buttons[idx1].config(bg="lightgreen", state="disabled")
            self.buttons[idx2].config(bg="lightgreen", state="disabled")
            self.matches_found += 1
            
            # ç‰¹æ®Šç©æ³•ï¼šçå‹µæ™‚é–“
            self.total_time += 5
            self.update_time_label()
            
            self.reset_selection()
            if self.matches_found == 8:
                self.game_over(win=True)
        else:
            # é…å°å¤±æ•—ï¼šæ‡²ç½°æ™‚é–“
            self.total_time -= 2
            self.update_time_label()
            self.root.after(1000, self.hide_pair)

    def hide_pair(self):
        # æª¢æŸ¥éŠæˆ²æ˜¯å¦é‚„åœ¨é€²è¡Œï¼ˆé¿å…æ™‚é–“çµæŸå¾Œé‚„åŸ·è¡Œé€™è£¡å ±éŒ¯ï¼‰
        if self.game_running:
            self.buttons[self.first_selection].config(text=" ", bg="SystemButtonFace")
            self.buttons[self.second_selection].config(text=" ", bg="SystemButtonFace")
            self.reset_selection()

    def reset_selection(self):
        self.first_selection = None
        self.second_selection = None
        self.is_checking = False

    def game_over(self, win):
        self.game_running = False
        if win:
            messagebox.showinfo("éŠæˆ²çµæŸ", f"æ­å–œé€šé—œï¼\nå‰©é¤˜æ™‚é–“ï¼š{self.total_time} ç§’")
        else:
            # æ™‚é–“åˆ°ï¼Œç¿»é–‹æ‰€æœ‰ç‰Œçµ¦ç©å®¶çœ‹
            for i, btn in enumerate(self.buttons):
                btn.config(text=self.cards[i], bg="lightgray")
            messagebox.showinfo("éŠæˆ²çµæŸ", "æ™‚é–“åˆ°ï¼æŒ‘æˆ°å¤±æ•— ğŸ’€")

    def reset_game(self):
        # é‡ç½®æ‰€æœ‰æ•¸å€¼
        self.total_time = 60
        self.peek_uses = 1
        self.matches_found = 0
        self.first_selection = None
        self.second_selection = None
        self.is_checking = False
        
        # é‡ç½® UI
        self.peek_btn.config(text=f"ğŸ‘ï¸ é€è¦–çœ¼ ({self.peek_uses})", state="normal")
        self.update_time_label()
        
        # é‡æ–°ä½ˆå±€
        self.setup_board()
        
        # ç¢ºä¿è¨ˆæ™‚å™¨é‡æ–°å•Ÿå‹• (å¦‚æœä¹‹å‰å·²ç¶“åœæ­¢)
        if not self.game_running: 
            self.game_running = True
            self.start_timer()

if __name__ == "__main__":
    root = tk.Tk()
    game = AdvancedMemoryGame(root)
    root.mainloop()
